<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="{{ url_for('static', path='/assets/') }}" 
  data-template="vertical-menu-template">
  <head>
    {% include 'header_file.html' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        .alert-msg {
          background-color: #f44336; /* Red */
          color: white;
          padding: 15px;
          margin: 10px 0;
          border-radius: 5px;
          animation-duration: 0.6s;
          position: relative;
          transition: opacity 0.5s ease, transform 0.5s ease;
      }
      
      .slide-in {
          opacity: 0;
          transform: translateY(-20px);
      }
      
      .slide-in-active {
          opacity: 1;
          transform: translateY(0);
      }
      
      .slide-out {
          opacity: 1;
          transform: translateY(0);
      }
      
      .slide-out-active {
          opacity: 0;
          transform: translateY(-20px);
      }
      
      .alert-success {
        background-color: #4CAF50; 
      }

.progress {
  background-color: #e9ecef;
  box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
}

.progress-bar {
  transition: width 0.4s ease;
  font-weight: 600;
}

  

      
       </style>
  </head>

  <body>

    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        {% include 'side_nav.html' %}
        <div class="layout-page">
          {% include 'header_nav.html' %}
          <div class="content-wrapper">
         
            <div class="container-xxl flex-grow-1 container-p-y">

                <h4 class="py-3 breadcrumb-wrapper mb-4">
                    <span class="text-muted fw-light">{{ session.role_name }} /</span>VMS Files
                </h4>

                <div id="alert-container" style="position: fixed; top: 50px; right: 50px; z-index: 1000;"></div>
                <div id="loading" style="display:none; position: fixed; top: 50%; left: 55%; transform: translate(-50%, -50%); z-index: 1000;">
                    <div class="col">
                        <div class="sk-fold sk-primary">
                            <div class="sk-fold-cube"></div>
                            <div class="sk-fold-cube"></div>
                            <div class="sk-fold-cube"></div>
                            <div class="sk-fold-cube"></div>
                        </div>
                    </div>  
                </div>
  
                <div class="row mb-4 col-12">
                    {% if session.role_id == 0 or page_permission %}

                    <div class="col-12 mb-4">
                        <div class="card">
                            <h5 class="card-header">On-Demand Video Download</h5>
                            <div class="card-body">
                                <div class="row">

                                    <p  style="margin-bottom: 15px; font-size: 16px; ">Video available from: <strong style="color: #007bff;">{{ start_time }}</strong> to <strong style="color: #007bff;">{{ end_time }}</strong></p>
                                    
                                    <div class="col-md-6">
                                        <label for="from-datetime" class="form-label">From Datetime</label>
                                        <input class="form-control" type="datetime-local" id="from-datetime">
                                    </div>
                    
                                    <div class="col-md-6">
                                        <label for="end-datetime" class="form-label">End Datetime</label>
                                        <input class="form-control" type="datetime-local" id="end-datetime" disabled>
                                    </div>
                                </div>
                    
                                <div class="text-center mt-5">
                                    <button class="btn btn-primary" id="request-btn">Video Request</button>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    

                
                    <div class="col-12 mb-4">
                        <div class="card">
                            <h5 class="card-header">VMS</h5>
                            <div class="card-body">
                                <div class="row">
                                    <div class="table-responsive">
                                    <table class="table table-bordered" id="vms_table">
                                        <thead>
                                            <tr>
                                                <th>S No</th>
                                                <th>Proj ID</th>
                                                <th>Detect ID</th>
                                                <th>Cam IP</th>
                                                <th>Event Time</th>
                                                <th>Request Start Time</th>
                                                <th>Request End Time </th>
                                                <th>Request Status </th>
                                                <th>Download/Preview</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                 
                {% else %}
                <div class=" h-100">
                  <div class="card-header">
                      <div class="alert alert-danger" role="alert">
                          Access Denied: You do not have the necessary permissions to view this page.
                      </div>
                  </div>
              </div>                   
              {% endif %}




            </div>

           
            
            <!-- / Content -->

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Video Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <video id="videoPreview" width="100%" controls>
                    <source id="videoSource" src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>
</div>


            

            <div class="content-backdrop fade"></div>
          </div>
        </div>
      </div>
      <div class="layout-overlay layout-menu-toggle"></div>

      <div class="drag-target"></div>
    </div>


    {% include 'script_file.html' %}
    
  </body>
 
<script type="text/javascript">
$(document).ready(function() {

    document.getElementById('from-datetime').addEventListener('change', function () {
    const fromDatetime = new Date(this.value);
    if (isNaN(fromDatetime.getTime())) return;

    // Add 2 minutes
    fromDatetime.setMinutes(fromDatetime.getMinutes() + 5);

    // Format as 'YYYY-MM-DDTHH:mm'
    const pad = (n) => n.toString().padStart(2, '0');
    const formatted = `${fromDatetime.getFullYear()}-${pad(fromDatetime.getMonth() + 1)}-${pad(fromDatetime.getDate())}T${pad(fromDatetime.getHours())}:${pad(fromDatetime.getMinutes())}`;

    document.getElementById('end-datetime').value = formatted;
});

    $("#request-btn").click(function() {
        let startTime = $("#from-datetime").val();
        let endTime = $("#end-datetime").val();
        const project_id = {{ project_id | tojson }};
        const detection_id = {{ detection_id | tojson }};
        const camera_ip = {{ camera_ip | tojson }};


        const availableStartTime = new Date({{ start_time | tojson }});
        const availableEndTime = new Date({{ end_time | tojson }});
        const selectedStartTime = new Date(startTime);
        const selectedEndTime = new Date(endTime);

        

        // Round available times to nearest minute
        availableStartTime.setSeconds(0, 0);
        availableEndTime.setSeconds(0, 0);
        selectedStartTime.setSeconds(0, 0);
        selectedEndTime.setSeconds(0, 0);


        

        if (!startTime || !endTime) {
            Toastify({
                text: "Please select both Start and End datetime.",
                duration: 3000,
                gravity: "top", 
                position: "center",
                backgroundColor: "#ff4d4d"
            }).showToast();
            return;
        }
        // Check if start time is within available video range
        // if (selectedStartTime < availableStartTime || selectedStartTime > availableEndTime) {
        //     Toastify({
        //         text: `Start time must be between ${availableStartTime.toLocaleString()} to ${availableEndTime.toLocaleString()}`,
        //         duration: 4000,
        //         gravity: "top",
        //         position: "center",
        //         backgroundColor: "#ff4d4d"
        //     }).showToast();
        //     return;
        // }
        let requestData = {
            project_id: project_id,
            detection_id: detection_id,
            camera_ip: camera_ip,
            request_start_time: startTime,
            request_end_time: endTime
        };

        $.ajax({
            url: "/main/cloud/videorequest/",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(requestData),
            success: function(response) {
                Toastify({
                    text: response.message,
                    duration: 3000,
                    gravity: "top", 
                    position: "center",
                    backgroundColor: "#28a745"
                }).showToast();
    
                setTimeout(() => location.reload(), 3000); 
            },
            error: function(xhr) {
                let errorMessage = "An error occurred while submitting the request.";
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                Toastify({
                    text: errorMessage,
                    duration: 3000,
                    gravity: "top", 
                    position: "center",
                    backgroundColor: "#ff4d4d"
                }).showToast();
            }
        });

    });

    const project_id = {{ project_id | tojson }};
    const detection_id = {{ detection_id | tojson }};
    const camera_ip = {{ camera_ip | tojson }};
    
    function loadDataTable() {
        if ($.fn.DataTable.isDataTable('#vms_table')) {
            $('#vms_table').DataTable().destroy();
        }

        $('#vms_table').DataTable({
            "ajax": {
                "url": `/main/videorequest/vms/project/${project_id}/camera_ip/${camera_ip}/detection/${detection_id}/`,
                "type": "GET",
                "dataSrc": function(json) {                    
                    return json.data;
                },
                "error": function(xhr, status, error) {                                      
                    console.error("DataTable AJAX Error:", error);
                    $('#vms_table').DataTable().clear().draw();
                }
            },
            "columns": [
                { 
                    "data": null, 
                    "title": "S.No", 
                    "render": function(data, type, row, meta) {
                        return meta.row + 1; 
                    }
                },
                { "data": "project_id" },
                { "data": "detection_id" },
                { "data": "camera_ip" },
                { "data": "event_time" },                
                { "data": "request_start_time" },
                { "data": "request_end_time" },
                {
                    "data": "file_status_code",
                    "render": function(data, type, row) {
                        let percentage = 0;
                        if (row.file_count > 0) {
                        percentage = Math.floor((row.upload_count / row.file_count) * 100);
                        }

                        if (data === 1) {
                        return `
                            <div style="min-width: 180px;">
                            <div class="d-flex align-items-center mb-1">
                                <div class="spinner-border spinner-border-sm text-info me-2" role="status"></div>
                                <strong>Processing ${percentage}%</strong>
                            </div>
                            <div class="progress" style="height: 20px; border-radius: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                    role="progressbar" 
                                    style="width: ${percentage}%; font-size: 14px;"
                                    aria-valuenow="${percentage}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                ${percentage}%
                                </div>
                            </div>
                            </div>
                        `;
                        }

                        // Other status cases
                        switch (data) {
                        case 0:
                            return `<span class="badge bg-warning text-dark">Initialized</span>`;
                        case 2:
                            return `<span class="badge bg-primary">Merging</span>`;
                        case 3:
                            return `<span class="badge bg-success">Completed</span>`;
                        case 4:
                            return `<span class="badge bg-danger">NO DATA</span>`;
                        case 5:
                            return `<span class="badge bg-danger">UPLOAD ERROR</span>`;
                        case 6:
                            return `<span class="badge bg-primary">Hold</span>
                            <div style="min-width: 180px;">
                            
                            <div class="progress mt-1" style="height: 20px; border-radius: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                    role="progressbar" 
                                    style="width: ${percentage}%; font-size: 14px;"
                                    aria-valuenow="${percentage}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                ${percentage}%
                                </div>
                            </div>
                            </div>
                            `;
                        case 7:
                            return `<span class="badge bg-secondary">Resume [PROCESSING]</span>
                            <div style="min-width: 180px;">
                            
                            <div class="progress mt-1" style="height: 20px; border-radius: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                    role="progressbar" 
                                    style="width: ${percentage}%; font-size: 14px;"
                                    aria-valuenow="${percentage}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                ${percentage}%
                                </div>
                            </div>
                            </div>
                            `;
                        default:
                            return `<span class="badge bg-danger">Failed</span>`;
                        }
                    }
                }, 
                {
                    "data": null,
                    "render": function (data, type, row) {
                        let disablePreview = "";
                        let disableDownload = "";
                        let disablePause = "";
                        let disableResume = "";

                        // ðŸ”¹ Processing (1) â†’ Only Pause enabled
                        if (row.file_status_code === 1) {
                            disablePreview = "disabled";
                            disableDownload = "disabled";
                            disableResume = "disabled";
                        }

                        //  Paused/Hold (6) â†’ Only Resume enabled
                        if (row.file_status_code === 6) {
                            disablePreview = "disabled";
                            disableDownload = "disabled";
                            disablePause = "disabled";
                        }

                        //  Resume (7) â†’ Only Hold enabled
                        if (row.file_status_code === 7) {                          
                            disablePause = "";
                        }


                        // ðŸ”¹ Completed (3) â†’ Only Preview & Download enabled
                        if (row.file_status_code === 3) {
                            disablePause = "disabled";
                            disableResume = "disabled";
                        }

                        // ðŸ”¹ Default â†’ disable preview & download if not completed
                        if (row.file_status_code !== 3) {
                            disablePreview = "disabled";
                            disableDownload = "disabled";
                        }

                        return `
                            <div class="d-flex gap-1 align-items-center">
                                <button class="btn btn-info btn-sm preview-btn" 
                                    data-bs-toggle="tooltip" title="Preview Video"
                                    ${disablePreview}
                                    data-project_id="${row.project_id}" 
                                    data-detection_id="${row.detection_id}" 
                                    data-camera_ip="${row.camera_ip}" 
                                    data-request_start_time="${row.request_start_time}"
                                    data-request_end_time="${row.request_end_time}">
                                    <i class="fa fa-eye"></i>
                                </button>

                                <button class="btn btn-success btn-sm download-btn" 
                                    data-bs-toggle="tooltip" title="Download Video"
                                    ${disableDownload}
                                    data-project_id="${row.project_id}" 
                                    data-detection_id="${row.detection_id}" 
                                    data-camera_ip="${row.camera_ip}" 
                                    data-request_start_time="${row.request_start_time}" 
                                    data-request_end_time="${row.request_end_time}">
                                    <i class="fa-solid fa-download"></i>
                                </button>

                                <button class="btn btn-primary btn-sm resume-btn"
                                    data-bs-toggle="tooltip" title="Resume Upload"
                                    ${disableResume}
                                    data-pk_id="${row.pk_id}"
                                    data-project_id="${row.project_id}" 
                                    data-detection_id="${row.detection_id}" 
                                    data-camera_ip="${row.camera_ip}" 
                                    data-request_start_time="${row.request_start_time}" 
                                    data-request_end_time="${row.request_end_time}">
                                    <i class="fa fa-play"></i>
                                </button>

                                <button class="btn btn-warning btn-sm pause-btn"
                                    data-bs-toggle="tooltip" title="Pause Upload"
                                    ${disablePause}
                                    data-pk_id="${row.pk_id}"
                                    data-project_id="${row.project_id}" 
                                    data-detection_id="${row.detection_id}" 
                                    data-camera_ip="${row.camera_ip}" 
                                    data-request_start_time="${row.request_start_time}" 
                                    data-request_end_time="${row.request_end_time}">
                                    <i class="fa fa-pause"></i>
                                </button>
                            </div>
                        `;
                    }
                },
                {
                    "data": null,
                    "render": function(data, type, row) {
                        return `
                            <div class="dropdown">
                                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item edit-ondemand" href="javascript:void(0);" data-pk_id="${row.pk_id}">
                                        <i class="bx bx-edit-alt me-1"></i> Edit
                                    </a>
                                    <a class="dropdown-item delete-ondemand" href="javascript:void(0);"  data-proj_id="${row.project_id}" data-det_id="${row.detection_id}"
                                        data-from_time="${row.request_start_time}"data-to_time="${row.request_end_time}"data-pk_id="${row.pk_id}">
                                        <i class="bx bx-trash me-1"></i> Delete
                                    </a>
                                    

                                </div>
                            </div>
                        `;
                    }
                }
                
            ]
        });
    }

    loadDataTable();
    $('#vms_table').on('draw.dt', function () {
        $('[data-bs-toggle="tooltip"]').tooltip();
    });

    $('#vms_table tbody').on('click', '.download-btn', function() {
        let button = $(this);        
        let project_id = button.data("project_id");
        let detection_id = button.data("detection_id");
        let camera_ip = button.data("camera_ip");
        let request_start_time = button.data("request_start_time");
        let request_end_time = button.data("request_end_time");
    
        //let downloadUrl = `/cloud/videorequest/local/download?project_id=${project_id}&detection_id=${detection_id}&camera_ip=${camera_ip}`;
        let downloadUrl = `/cloud/videorequest/local/download?project_id=${project_id}&detection_id=${detection_id}&camera_ip=${camera_ip}&request_start_time=${request_start_time}&request_end_time=${request_end_time}`;

        window.location.href = downloadUrl;
    });


    $('#vms_table tbody').on('click', '.delete-ondemand', function() {

        var pk_id = $(this).data('pk_id');  
        var project_id = $(this).data('proj_id');
        var detection_id = $(this).data('det_id');

        var fromTime = $(this).data('from_time');
        var toTime = $(this).data('to_time');

        console.log("Deleting pk_id:", pk_id, "from:", fromTime, "to:", toTime,"projectid_id",project_id,"detection_id",detection_id);
        

        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to delete the on-demand video request (From: ${fromTime} To: ${toTime}). This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/main/ondemand/delete/${pk_id}/${project_id}/${detection_id}`,   
                    method: 'DELETE',
                    success: function(response) {
                        Swal.fire('Deleted!', `The on-demand request (From: ${fromTime} To: ${toTime}) has been successfully deleted.`, 'success');
                        $('#vms_table').DataTable().ajax.reload();
                    },
                    error: function(xhr, status, error) {
                        Swal.fire('Error!', 'Failed to delete the on-demand request. Please try again.','error');
                    }
                });
            }
        }); 
    });
    
    //resume option for on demand funtioality
    $(document).on("click",".resume-btn",function(){
        let button= $(this);
        var pk_id = $(this).data('pk_id'); 
        let project_id = button.data("project_id");
        let detection_id = button.data("detection_id");
        let camera_ip = button.data("camera_ip");
        let fromTime = button.data("request_start_time");
        let toTime = button.data("request_end_time");
        console.log("id:",pk_id,"camera_ip:",camera_ip,"from:", fromTime, "to:", toTime,"projectid_id",project_id,"detection_id",detection_id);
        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to Resume the on-demand video request (From: ${fromTime} To: ${toTime}). This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Resume it!'
        }).then((result) => {
            if (result.isConfirmed){
                $.ajax({
                    url: `/main/ondemand/resume/${pk_id}/${project_id}/${detection_id}`,   
                    method: 'PUT',
                    success: function(response) {
                        Swal.fire('Resume!', `The On-demand request (From: ${fromTime} To: ${toTime}) has been successfully deleted.`, 'success');
                        $('#vms_table').DataTable().ajax.reload();
                    },
                    error: function(xhr, status, error) {
                        Swal.fire('Error!', 'Failed to Resume the on-demand request. Please try again.','error');
                    }
                });
            }
        });
    });
    // hold option for on demand functionality
    $(document).on("click",".pause-btn", function(){
        let button= $(this);
        var pk_id = $(this).data('pk_id'); 
        let project_id = button.data("project_id");
        let detection_id = button.data("detection_id");
        let camera_ip = button.data("camera_ip");
        let fromTime = button.data("request_start_time");
        let toTime = button.data("request_end_time");
        console.log("id:",pk_id,"camera_ip:",camera_ip,"from:", fromTime, "to:", toTime,"projectid_id",project_id,"detection_id",detection_id);
        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to Hold the on-demand video request (From: ${fromTime} To: ${toTime}). This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, Hold it!'
        }).then((result) => {
            if (result.isConfirmed) { 
                $.ajax({
                    url: `/main/ondemand/hold/${pk_id}/${project_id}/${detection_id}`,   
                    method: 'PUT',
                    success: function(response) {
                        Swal.fire('Hold!', `The On-demand request (From: ${fromTime} To: ${toTime}) has been successfully deleted.`, 'success');
                        $('#vms_table').DataTable().ajax.reload();
                    },
                    error: function(xhr, status, error) {
                        Swal.fire('Error!', 'Failed to hold the on-demand request. Please try again.','error');
                    }
                });
            }
        });
    });

    $(document).on("click", ".preview-btn", function () {
        var WEBSOCKET_CLOUD_URL = "{{ WEBSOCKET_CLOUD_URL }}";
        const base_url = `http://${WEBSOCKET_CLOUD_URL}/cloud_video/`;
 
        let button = $(this);
        
        let project_id = button.data("project_id");
        let detection_id = button.data("detection_id");
        let camera_ip = button.data("camera_ip");
        let request_start_time = button.data("request_start_time");
        let request_end_time = button.data("request_end_time");
    
        let videoUrl = `${base_url}proj_id_${project_id}/camera_${camera_ip}/detect_id_${detection_id}/${request_start_time}_to_${request_end_time}.mp4`;

        $("#videoSource").attr("src", videoUrl);
        $("#videoPreview")[0].load();  // Reload the video source
        $("#previewModal").modal("show");  // Show the modal
    });
    

    
});

setInterval(() => {
  $('#vms_table').DataTable().ajax.reload(null, false);  // false = don't reset pagination
}, 5000);  // Refresh every 5 seconds

        
    

</script>




</html>