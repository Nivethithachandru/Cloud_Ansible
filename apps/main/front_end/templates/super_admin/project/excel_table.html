<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="{{ url_for('static', path='/assets/') }}" 
  data-template="vertical-menu-template">
  <head>
    {% include 'header_file.html' %}
    <style>
       /* Fixed height for both cards */
    .fixed-panel {
        height: 400px;        /* adjust as per your layout */
        overflow-x: auto;     /* horizontal scroll */
        overflow-y: auto;     /* vertical scroll */
    }

    /* Ensure table inside scrolls properly */
    .card-datatable {
        min-width: 500px;     /* force horizontal scroll if needed */
    }

        .alert-msg {
            background-color: #f44336; /* Red */
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            animation-duration: 0.6s;
            position: relative;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .slide-in {
            opacity: 0;
            transform: translateY(-20px);
        }

        .slide-in-active {
            opacity: 1;
            transform: translateY(0);
        }

        .slide-out {
            opacity: 1;
            transform: translateY(0);
        }

        .slide-out-active {
            opacity: 0;
            transform: translateY(-20px);
        }
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
            </style>
  </head>

  <body>

    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        {% include 'side_nav.html' %}
        <div class="layout-page">
          {% include 'header_nav.html' %}
          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <h4 class="py-3 breadcrumb-wrapper mb-4">
                  <span class="text-muted fw-light">{{ session.role_name }} /</span> Hourly Report
              </h4>
              <div id="alert-container" style="position: fixed; top: 50px; right: 50px; z-index: 1000;"></div>



<div class="row">
<div class="col-md-4">
<div class="card mb-4 fixed-panel">
<h5 class="card-header"> Group Class Assesments </h5>
<div class="card-body">
    

        <form id="role_assessment_form">
            <div id="loadingMessage" class="alert alert-info" style="display: none;"></div>
            <div id="alertMessage" style="display: none;" class="mb-3 mt-3"></div>

            <div class="mb-3">
                <label class="form-label" for="custom_class_id">Custom Class Name</label>
                <select class="form-control" id="custom_class_id" name="custom_class_id" required>
                    <option value="" selected disabled>Select Custom Class</option>
                    {% for class in custom_class %}
                    <option value="{{ class.id }}">{{ class.custom_class }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-4">
                <label for="orginal_class_id" class="form-label select2-success">Map Weight Class</label>
                <select id="orginal_class_id" name="orginal_class_id[]" class="select2 form-select" multiple="multiple">
                    <option value=""></option>
                </select>
            </div>
            

            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
</div>
</div>
</div>
<div class="col-md-8">                  
<div class="card mb-4 fixed-panel">
<div class="d-flex justify-content-between align-items-center">
    <h5 class="card-header me-2">Custom Classes List</h5>
    <a class="btn btn-primary" href="{{ url_for('main.class_management') }}">
        New Custom Class
    </a>
</div>


<div class="card-body">
    <p style="color:#f44336;"><b>NETC</b> - National Electronic Toll Collection</p>

    <div class="card-datatable text-nowrap table-responsive">
        <table class=" table table-bordered" id="roletable">
            <thead>
                <tr>
                    <th>S No.</th>
                    <th>Clases Name</th> 
                    <th>Model Group</th>                                                               
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>
    </div>
</div>
</div>
</div>
</div>     



                    <div class="card mt-5">
                    <h5 class="card-header">Excel Download</h5>
     
                    <div class="card-datatable text-nowrap table-responsive">
                        <table class=" table table-bordered" id="users_table">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Detection ID</th>
                                    <th>Project Name</th>
                                    <th>Camera IP</th>
                                    <th>Start Time</th> 
                                    <th>End Time</th>
                                    <th>Classes</th>
                                    <th>Download</th>
                                </tr>
                               
                            </thead>
                            <tbody>
                                {% for interval in hourly_intervals %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ detection_id }}</td>
                                    <td>{{ project_name }}</td>
                                    <td>{{ camera_ip }}</td>
                                    <td>{{ interval.start }}</td>
                                    <td> {{ interval.end }}</td>
                                    <td>
                    <!-- <select class="form-control" id="select_custom_clases" name="select_custom_clases" required>
                    <option value="" selected disabled>Select Custom Class</option>
                    <option value="1">NETC Classes</option>
                    <option value="2">Grouped Classes</option>
                    </select> -->

<select class="form-control select_custom_classes"  name="select_custom_classes[]" multiple="multiple">
    {% for cls in custom_classes %}
        <option value="{{ cls.id }}">{{ cls.custom_class }}</option>
    {% endfor %}
</select>





                                    </td>
                                    <td>
<!-- <button type = "submit" class ="btn btn-sm btn-success download-btn"
onclick="Downloadexcel('{{ detection_id }}','{{project_id}}','{{interval.start}}','{{interval.end}}', '{{ camera_ip }}','{{line_id}}',this)">
Download</button> -->
 <button type="submit" 
          class="btn btn-sm btn-success download-btn"
          onclick="Downloadexcel('{{ detection_id }}','{{project_id}}','{{interval.start}}','{{interval.end}}','{{ camera_ip }}','{{line_id}}', this)">
      Download
  </button>


                                    </td>
                                </tr>
                                {% endfor %}

                                 
                            </tbody>
                        </table>
                    </div>
              </div>


              
          </div>
          <div id="alert-container" style="position: fixed; top: 50px; right: 50px; z-index: 1000;"></div>
                <div id="loading" style="display:none; position: fixed; top: 50%; left: 55%; transform: translate(-50%, -50%); z-index: 1000;">
                    <div class="col">
                        <div class="sk-fold sk-primary">
                            <div class="sk-fold-cube"></div>
                            <div class="sk-fold-cube"></div>
                            <div class="sk-fold-cube"></div>
                            <div class="sk-fold-cube"></div>
                        </div>
                    </div>  
                </div>
           

            

            <div class="content-backdrop fade"></div>
          </div>
        </div>
      </div>
      <div class="layout-overlay layout-menu-toggle"></div>

      <div class="drag-target"></div>
    </div>


    {% include 'script_file.html' %}NETC
    
  </body>
  <script>
$(document).ready(function() {
 

  $('.select_custom_classes').select2({
        placeholder: "Select Custom Classes",
        allowClear: true,
        width: 'resolve' // prevents sizing issues inside DataTable
    });
            
    $('#users_table').DataTable({
    autoWidth: true, 
    });})

$("#custom_class_id").change(function(){
    var custom_id = $(this).val(); 
    console.log("Custom Class ID", custom_id);

    $.ajax({
        url: '/main/group_classes/fetch_ori_class/',
        type: 'POST',
        contentType: 'application/json',   
        data: JSON.stringify({ custom_id: custom_id }),  
        success: function(response){
            var originalClasses = response.data;  
            var checked_list_ids = response.already_exisit_list;

            console.log("originalClasses", originalClasses);
            console.log("checked_list_ids", checked_list_ids);

            $("#orginal_class_id").empty(); 
            $("#orginal_class_id").append(
                $('<option></option>').attr("value", "ALL").text("Select All")
            );
            $.each(originalClasses, function(index, classData) {
                var option = $('<option></option>')
                    .attr("value", classData.m_classes_id) 
                    .text(classData.m_classes_name); 

                if (checked_list_ids.includes(classData.m_classes_id)) {
                    option.prop('selected', true); 
                }
                
                $("#orginal_class_id").append(option);
            });

            $("#orginal_class_id").trigger('change'); 
        },
        error: function(xhr, status, error){
            console.log("Error", error);  
        }
    });
});

window.Downloadexcel = async function(detection_id, project_id, start, end, camera_ip, line_id, button) {
    const row = button.closest("tr");
    const selectElement = row.querySelector(".select_custom_classes"); // use class
    const selectedValues = Array.from(selectElement.selectedOptions).map(option => option.value);

    if (selectedValues.length === 0) {
        alert("Please select at least one class before downloading.");
        return;
    }

    const selectedClassList = selectedValues.join(","); // send as comma-separated string if needed

    const ip = location.host;
    const timestamp = new Date().toISOString().replace(/[-:T.]/g, '_').slice(0, 19);

    const allButtons = document.querySelectorAll(".download-btn");
    allButtons.forEach(btn => btn.disabled = true);
    loading.style.display = 'inline-block';

    try {
        const response = await fetch(`/realtime/download_records?project_id=${project_id}&camera_ip=${camera_ip}&detection_id=${detection_id}&start_time=${start}&end_time=${end}&line_id=${line_id}&selected_custom_class=${selectedClassList}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
            const text = await response.text();
            let errorMessage = 'An error occurred. Please try again later.';
            if (text.includes("No records found")) errorMessage = "No records found for the selected time range.";
            else if (response.status === 404) errorMessage = "Requested resource not found.";
            else if (response.status === 400) errorMessage = "Bad request. Please check your inputs.";
            throw new Error(errorMessage);
        }

        alertHandler("Download initiated!", true);

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const fileName = `Realtime_hourly_report_${selectedClassList}_${timestamp}.xlsx`;

        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

    } catch (error) {
        console.error('Error downloading the report:', error);
        alertHandler(error.message, false);
    } finally {
        loading.style.display = 'none';
        allButtons.forEach(btn => btn.disabled = false);
    }
}


// window.Downloadexcel = async function(detection_id, project_id, start, end, camera_ip, line_id, button) {
//     const row = button.closest("tr");
//     const selectedClass = row.querySelector("#select_custom_clases").value;

//     if (!selectedClass) {
//         alert("Please select a class before downloading.");
//         return;
//     }

//     const ip = location.host;
//     const timestamp = new Date().toISOString().replace(/[-:T.]/g, '_').slice(0, 19);

//     const allButtons = document.querySelectorAll(".download-btn");
//     allButtons.forEach(btn => btn.disabled = true);
//     loading.style.display = 'inline-block';

//     try {
//         const response = await fetch(`/realtime/download_records?project_id=${project_id}&camera_ip=${camera_ip}&detection_id=${detection_id}&start_time=${start}&end_time=${end}&line_id=${line_id}&selected_custom_class=${selectedClass}`, {
//             method: 'GET',
//             headers: { 'Content-Type': 'application/json' }
//         });

//         if (!response.ok) {
//             const text = await response.text();
//             let errorMessage = 'An error occurred. Please try again later.';
//             if (text.includes("No records found")) errorMessage = "No records found for the selected time range.";
//             else if (response.status === 404) errorMessage = "Requested resource not found.";
//             else if (response.status === 400) errorMessage = "Bad request. Please check your inputs.";
//             throw new Error(errorMessage);
//         }

//         alertHandler("Download initiated!", true);

//         const blob = await response.blob();
//         const url = window.URL.createObjectURL(blob);
//         const fileName = `Realtime_hourly_report_${selectedClass}_${timestamp}.xlsx`;

//         const a = document.createElement('a');
//         a.href = url;
//         a.download = fileName;
//         document.body.appendChild(a);
//         a.click();
//         document.body.removeChild(a);

//     } catch (error) {
//         console.error('Error downloading the report:', error);
//         alertHandler(error.message, false);
//     } finally {
//         loading.style.display = 'none';
//         allButtons.forEach(btn => btn.disabled = false);
//     }
// }
// async function Downloadexcel(detection_id, project_id, start, end, camera_ip, line_id, button) {
//     const ip = location.host;
//     console.log('IP Address:', ip);
//     console.log('Project ID:', project_id);
//     console.log('Camera IP:', camera_ip);
//     console.log('Detection ID:', detection_id);
//     console.log('Start Time:', start);
//     console.log('End Time:', end);
//     console.log('Line ID:', line_id);

//     const timestamp = new Date().toISOString().replace(/[-:T.]/g, '_').slice(0, 19);

//     // Disable all download buttons
//     const allButtons = document.querySelectorAll(".download-btn");
//     allButtons.forEach(btn => {
//         btn.disabled = true;
//     });

//     loading.style.display = 'inline-block';

//     try {
//         const response = await fetch(`/realtime/download_records?project_id=${project_id}&camera_ip=${camera_ip}&detection_id=${detection_id}&ip=${ip}&start_time=${start}&end_time=${end}&line_id=${line_id}`, {
//             method: 'GET',
//             headers: { 'Content-Type': 'application/json' }
//         });

//         if (!response.ok) {
//             const text = await response.text();
//             let errorMessage = 'An error occurred. Please try again later.';

//             if (text.includes("No records found")) {
//                 errorMessage = "No records found for the selected time range.";
//             } else if (response.status === 404) {
//                 errorMessage = "Requested resource not found.";
//             } else if (response.status === 400) {
//                 errorMessage = "Bad request. Please check your inputs.";
//             }

//             throw new Error(errorMessage);
//         }

//         alertHandler("Download initiated!", true);

//         const blob = await response.blob();
//         const url = window.URL.createObjectURL(blob);

//         const formattedStartTime = start.replace(/-/g, '_');
//         const formattedEndTime = end.replace(/-/g, '_');
//         const fileName = `Realtime_hourly_report_${formattedStartTime}_${timestamp}.xlsx`;

//         const a = document.createElement('a');
//         a.href = url;
//         a.download = fileName;
//         document.body.appendChild(a);
//         a.click();
//         document.body.removeChild(a);

//     } catch (error) {
//         console.error('Error downloading the report:', error);
//         alertHandler(error.message, false);
//     } finally {
//         loading.style.display = 'none';
//         // Re-enable all buttons after download is complete
//         allButtons.forEach(btn => {
//             btn.disabled = false;
//         });
//     }
// }

function alertHandler(message, isSuccess) {
    const alertContainer = document.getElementById('alert-container');
    const alertClass = isSuccess ? 'alert-success' : 'alert-danger'; // Change class based on success or failure
    const alertMessage = document.createElement('div');
    alertMessage.className = `alert ${alertClass} alert-msg slide-in`;
    alertMessage.textContent = message;

    // Append the alert message to the container
    alertContainer.appendChild(alertMessage);

    // Trigger the slide-in effect
    setTimeout(() => {
        alertMessage.classList.add('slide-in-active');
    }, 10);

    // Remove the alert after some time
    setTimeout(() => {
        alertMessage.classList.remove('slide-in-active');
        alertMessage.classList.add('slide-out-active');

        // Remove the alert from the DOM after animation
        setTimeout(() => {
            alertContainer.removeChild(alertMessage);
        }, 500);
    }, 3000); // Duration before the alert starts to fade out
}



    

    </script>
    <script>
    $(document).ready(function () {
        $('#orginal_class_id').select2({
            placeholder: "Select Weight Class",  
            allowClear: true 
        });
        
      
        $("#custom_class_id").change(function(){
            var custom_id = $(this).val(); 
            console.log("Custom Class ID", custom_id);
    
            $.ajax({
                url: '/main/group_classes/fetch_ori_class/',
                type: 'POST',
                contentType: 'application/json',   
                data: JSON.stringify({ custom_id: custom_id }),  
                success: function(response){
                    var originalClasses = response.data;  
                    var checked_list_ids = response.already_exisit_list;
    
                    console.log("originalClasses", originalClasses);
                    console.log("checked_list_ids", checked_list_ids);
    
                    $("#orginal_class_id").empty(); 
                    $("#orginal_class_id").append(
                        $('<option></option>').attr("value", "ALL").text("Select All")
                    );
                    $.each(originalClasses, function(index, classData) {
                        var option = $('<option></option>')
                            .attr("value", classData.m_classes_id) 
                            .text(classData.m_classes_name); 
    
                        if (checked_list_ids.includes(classData.m_classes_id)) {
                            option.prop('selected', true); 
                        }
                        
                        $("#orginal_class_id").append(option);
                    });
    
                    $("#orginal_class_id").trigger('change'); 
                },
                error: function(xhr, status, error){
                    console.log("Error", error);  
                }
            });
        });
    });

    $('#orginal_class_id').on('select2:select', function (e) {
            var data = e.params.data;
            if (data.id === "ALL") {
                // Select all except "ALL"
                var allValues = [];
                $("#orginal_class_id option").each(function () {
                    if ($(this).val() !== "ALL") {
                        allValues.push($(this).val());
                    }
                });
                $('#orginal_class_id').val(allValues).trigger('change');
            }
        });

    
    
    $(document).ready(function () {
        $('#role_assessment_form').submit(function (e) {
            e.preventDefault();

            function showAlert(message, type = 'danger') {
                const alertMessageDiv = document.getElementById('alertMessage');
                alertMessageDiv.style.display = 'block';
                alertMessageDiv.innerText = message;
                alertMessageDiv.style.color = 'white';
                alertMessageDiv.style.backgroundColor = type === 'danger' ? 'red' : 'green';
                alertMessageDiv.style.padding = '10px';
                alertMessageDiv.style.borderRadius = '5px';
                setTimeout(function () {
                    alertMessageDiv.style.display = 'none';
                }, 5000);
            }

            function showLoading(message) {
                const loadingMessageDiv = document.getElementById('loadingMessage');
                loadingMessageDiv.style.display = 'block';
                loadingMessageDiv.innerText = message;
                loadingMessageDiv.style.color = 'white';
                loadingMessageDiv.style.backgroundColor = 'blue';
                loadingMessageDiv.style.padding = '10px';
                loadingMessageDiv.style.borderRadius = '5px';
            }

            function hideLoading() {
                const loadingMessageDiv = document.getElementById('loadingMessage');
                loadingMessageDiv.style.display = 'none';
            }

            let custom_class_id = $('#custom_class_id').val();
            let orginal_class_id = $('#orginal_class_id').val();

            showLoading("Submitting...");

            

            // -----------------------------------------------
            $.ajax({
                url: '/main/group_classes/add_update/',
                method: 'POST',
                contentType: "application/json",
                data: JSON.stringify({
                    custom_class_id: custom_class_id,
                    orginal_class_id: orginal_class_id
                }),
                success: function (response) {
                    //hideLoading();
                    //showAlert(`Custom Classes Mapped  successfully!`, 'success');
                    //console.log("Form Submitted Successfully:", response);
                    //$('#role_assessment_form')[0].reset();
                    //$('#orginal_class_id').val(null).trigger('change');  

                    hideLoading();

                    // Check backend message and show accordingly
                    if (response.message === "Mapping already exists for this custom class.") {
                        showAlert(response.message, 'info'); // info badge for existing mapping
                    } else {
                        showAlert(response.message || 'Custom Classes Mapped successfully!', 'success');
                    }

                    console.log("Form Submitted Successfully:", response);

                    // Reset form only if mapping was added/updated
                    if (response.message !== "Mapping already exists for this custom class.") {
                        $('#role_assessment_form')[0].reset();
                        $('#orginal_class_id').val(null).trigger('change');  
                    }

                },
                error: function (xhr) {
                    hideLoading();
                    let errorMessage = 'An unexpected error occurred. Please try again.';
                    if (xhr.status === 400) {
                        errorMessage = JSON.parse(xhr.responseText).detail;
                    }
                    showAlert("KIT IS OFFLINE", 'danger');
                }
            });
        });
    });


    function dbupdate() {
    fetch("/status_info", {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log("Fetched Data:", data);

        if (data.latest_status && data.latest_status.statuses && data.latest_status.statuses.mapping_status === true) {
            Toastify({
                text: data.latest_status.message || "Mapping Status is active!",
                duration: 6000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                stopOnFocus: true
            }).showToast();
        }
    })
    .catch(error => console.error("Error fetching status update:", error));
}

setInterval(dbupdate, 28000);
 
</script>
<script>
    $(document).ready(function() {
        $('#roletable').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "/main/classes/classeslist/",
                "dataSrc": "data"
            },
            "columns": [
                { "data": "serial_no" },
                { "data": "custom_class" },
                {
                    data: 'module_groups',
                    render: function(data) {
                        if (!data || data.length === 0) {
                            return `<span class="badge rounded-pill bg-label-info">Null</span>`;
                        }
                        const badges = data.map(item => {
                            return `<span class="badge rounded-pill bg-label-success">${item}</span>`;
                        });
                        return badges.join(' ');
                    }
                },
      
                {
                    "data": null,
                    "render": function(data, type, row) {
                        return `
                            <div class="dropdown">
                                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item edit-class" href="javascript:void(0);" data-id="${row.id}">
                                        <i class="bx bx-edit-alt me-1"></i> Edit
                                    </a>
                                    <a class="dropdown-item delete-class" href="javascript:void(0);" data-id="${row.id}" data-class-name="${row.custom_class}">
                                        <i class="bx bx-trash me-1"></i> Delete
                                    </a>
                                    

                                </div>
                            </div>
                        `;
                    }
                }
            ]
        });
    
        // Handle Delete button click
$('#roletable tbody').on('click', '.delete-class', function() {
    var classesId = $(this).data('id');       
    var classesName = $(this).data('class-name');   

    // If API returns success, allow deletion
    Swal.fire({
        title: 'Are you sure?',
        text: `You are about to delete the Custom Classes "${classesName}". This action cannot be undone!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/main/classes/delete/${classesId}`,   
                method: 'DELETE',
                success: function(response) {
                    Swal.fire('Deleted!', `The Classes "${classesName}" has been deleted.`, 'success');
                    $('#roletable').DataTable().ajax.reload();
                },
                error: function(xhr, status, error) {
                    Swal.fire('Error!', 'Failed to delete the Classes. Please try again.', 'error');
                }
            });
        }
    });

});


 $('#roletable tbody').on('click', '.edit-class', function() {
    var classesId = $(this).data('id');  
    $.ajax({
        url: '/main/lpu/status_check',
        type: 'GET',
        success: function(response) {
        
            window.location.href = `/main/classes/edit/${classesId}`;
        },
        error: function(xhr) {
            if (xhr.status === 400) {
                Swal.fire({
                    title: 'KIT is Offline!',
                    text: 'Cannot edit classes while KIT is offline.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: 'An unexpected error occurred.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    });
});
    });
    

</script>
    </html>