<!DOCTYPE html>

<html lang="en"
 class="light-style layout-navbar-fixed layout-menu-fixed" 
 dir="ltr" data-theme="theme-default" data-assets-path="{{ url_for('static', path='/assets/') }}" data-template="vertical-menu-template">
  <head>
    {% include 'header_file.html' %}
 <style>
  .alert-msg {
    background-color: #f44336; /* Red */
    color: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 5px;
    animation-duration: 0.6s;
    position: relative;
    transition: opacity 0.5s ease, transform 0.5s ease;
}

.slide-in {
    opacity: 0;
    transform: translateY(-20px);
}

.slide-in-active {
    opacity: 1;
    transform: translateY(0);
}

.slide-out {
    opacity: 1;
    transform: translateY(0);
}

.slide-out-active {
    opacity: 0;
    transform: translateY(-20px);
}

.alert-success {
  background-color: #4CAF50; 
}

 </style>
  </head>
  
  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->

        {% include 'side_nav.html' %}
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          {% include 'header_nav.html' %}

           

          <!-- / Navbar -->

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->

            <div class="container-xxl flex-grow-1 container-p-y">
              <h4 class="py-3 breadcrumb-wrapper mb-4">
                <span class="text-muted fw-light"> {{ session.role_name }} /</span> Audit Transaction
              </h4>

              <div id="alert-container" style="position: fixed; top: 50px; right: 50px; z-index: 1000;"></div>
              <div id="loading" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
                  <div class="col">
                      <div class="sk-fold sk-primary">
                          <div class="sk-fold-cube"></div>
                          <div class="sk-fold-cube"></div>
                          <div class="sk-fold-cube"></div>
                          <div class="sk-fold-cube"></div>
                      </div>
                  </div>  
              </div>

             
              {% if session.role_id == 0 or page_permission %}
              <div class="card mt-5">
                <h5 class="card-header">Filter Audit Transaction</h5>                  
                <div class="card-body">     
                  <div class="row col-12">

                    <div class="col-md-3 mb-3">
                      <label for="kit-select">Select Project</label>
                      <select id="kit-select" class="form-select">
                          <option value="" >Select Project</option>
                      </select>
                  </div>
                  <div class="col-md-3 mb-3">
                      <label for="cam-select">Select Camera</label>
                      <select id="cam-select" class="form-select">
                          <option value="" disabled>Select Camera</option>
                      </select>
                  </div>

              
                <div class="col-md-3 mb-3">

                <label for="from_date">From Date</label>
                  <input
                    type="text"
                    id="from_date"
                    name="from_date"
                    class="form-control dob-picker"
                    placeholder="YYYY-MM-DD" />

              </div>

              <div class="col-md-3 mb-3">
                <label for="to_date">To Date</label>
                  <input
                    type="text"
                    id="to_date"
                    name="to_date"
                    disabled
                    class="form-control dob-picker"
                    placeholder="YYYY-MM-DD" />
              </div>


                    <div class="pt-5 text-center">
                        <button type="submit" id="submitBtn"class="btn btn-primary  me-sm-3 me-1">Submit</button>
                    </div>

                  </div>                                        
                </div>
              </div>
              <div class="card mt-5">
                 <h5 class="card-header">Audit Transaction</h5>
                  <div class="card-datatable text-nowrap table-responsive">
                      <table class=" table table-bordered" id="reporttable">
                          <thead>
                              <tr>                                 
                              
                                <th>Vehicle ID</th>                                                         
                                <th>AI Name</th>
                                <th>Audited Class</th>
                                <th>Direction</th>
                                <th>Image Path</th>
                                <!-- <th>Last Modified By</th> -->
                                <th>Updated At</th>
                              </tr>
                          </thead>
                          <tbody>
                              
                          </tbody>
                      </table>
                  </div>
              </div>
              {% else %}
                <div class=" h-100">
                  <div class="card-header">
                      <div class="alert alert-danger" role="alert">
                          Access Denied: You do not have the necessary permissions to view this page.
                      </div>
                  </div>
              </div>                   
              {% endif %}

                
            <!-- Modal for Zooming Image -->
            <div class="modal fade" id="imageZoomModal" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="imageZoomModalLabel">Image Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img id="zoomedImage" src="" alt="Zoomed Image" style="width: 100%; max-height: 80vh; object-fit: contain;">
                        </div>
                    </div>
                </div>
            </div>

                 



           

            
       
              
            </div>
            
            </div>
          
            <div class="content-backdrop fade"></div>
          </div>
  
        </div>
 
      </div>
      <div class="layout-overlay layout-menu-toggle"></div>

      <div class="drag-target"></div>
    </div>

   {% include 'script_file.html' %}

  </body>
   

  <script src="{{ url_for('static', path='assets/js/form-layouts.js') }}"></script>

<script>

let table;   
const AUDIT_DATE_FILTER ={{ AUDIT_DATE_FILTER }}
$(document).ready(function() {
  async function fetchCameras(project_id) {
    try {
        const response = await fetch(`/get_cameraip/${project_id}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const cameras = await response.json();
        const camSelect = $('#cam-select');
        
        camSelect.empty();
        camSelect.append(new Option('Select Camera', '', true, true));

        cameras.forEach(camera => {
            // If camera.camera_ip is a stringified array or a single IP, parse it
            let cameraIps;
            try {
                cameraIps = JSON.parse(camera.camera_ip); // Parse stringified array
            } catch (e) {
                cameraIps = [camera.camera_ip]; // Fallback to single IP if parsing fails
            }

         
            cameraIps.forEach(ip => {
                camSelect.append(new Option(ip, ip));
            });
        });
    } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
    }
}



async function fetchKits() {
    try {
        const response = await fetch('/available_projects');
        if (!response.ok) throw new Error('Network response was not ok');
        const kits = await response.json();
        const kitSelect = $('#kit-select');
        kits.forEach(kit => {
            kitSelect.append(new Option(kit.project_name, kit.project_id));
        });

     
        kitSelect.on('change', function() {
            const selectedProjectId = $(this).val();
            if (selectedProjectId) {
                fetchCameras(selectedProjectId);
            }
        });

    } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
    }
}

fetchKits();

    $(document).on('click', '.table-image', function() {
        const imageUrl = $(this).data('image');
        const aiClass = $(this).data('ai-class');
        $('#zoomedImage').attr('src', imageUrl);     
        $('#imageZoomModalLabel').text(aiClass);   
        $('#imageZoomModal').modal('show');          
    });
    

    table = $('#reporttable').DataTable({
        pageLength: 5,  
    });

    $('#from_date').on('change', function() {
        const fromDate = $(this).val();
        if (fromDate) {
            const dateParts = fromDate.split('-'); 
            const year = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1; 
            const day = parseInt(dateParts[2], 10);
            const nextDate = new Date(year, month, day + AUDIT_DATE_FILTER);            
            const nextDateFormatted = nextDate.toISOString().split('T')[0];
            $('#to_date').val(nextDateFormatted);
        }
    });

    $('#submitBtn').on('click', function(e) {
        e.preventDefault();

        let project_id = $('#kit-select').val();
        let camera_ip = $('#cam-select').val();
       
        let fromDate = $('#from_date').val();
        let toDate = $('#to_date').val();
        
        console.log("fromDate",fromDate)
        console.log("toDate",toDate)

        if (!fromDate || !toDate) {
            alertHandler('All fields are required. Please fill in all fields.', false);
            return;
        }

        $.ajax({
            url: "/main/report/transaction_audit_filter/",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                project_id: project_id,
                camera_ip:camera_ip,
                from_date: fromDate,
                to_date: toDate
            }),
            beforeSend: function() {
                $('#loading').show();  
            },
            success: function(response) {
                $('#loading').hide(); 

                table.clear();

                response.data.forEach(function(item) {
                     console.log("updated_at:", item.updated_at, " | full item:", item);
                    table.row.add([
                            item.vehicle_id,
                            item.vehicle_name,
                            item.default_audited_class,
                            item.direction == 0 
                              ? '<div class="btn btn-label-success">DOWN</div>' 
                              : '<div class="btn btn-label-warning">UP</div>',  
                            
                            `<img src="${item.image_path}" alt="Image" class="table-image" 
                              data-image="${item.image_path}" 
                              data-ai-class="${item.audited_class}"                               
                              style="width: 100px; height:100px; cursor: pointer;" />`,
 
                            // item.last_modified,
                            item.updated_at                         
                    ]);
                });

                table.draw();
            },
            error: function(err) {
                $('#loading').hide(); 
                console.log(err);
                alertHandler('No Data Found!!', false);

            }
        });
    });
});



function alertHandler(message, isSuccess) {
    const alertContainer = document.getElementById('alert-container');
    const alertClass = isSuccess ? 'alert-success' : 'alert-danger'; 
    const alertMessage = document.createElement('div');
    alertMessage.className = `alert ${alertClass} alert-msg slide-in`;
    alertMessage.textContent = message;
    alertContainer.appendChild(alertMessage);
    setTimeout(() => {
        alertMessage.classList.add('slide-in-active');
    }, 10);
    setTimeout(() => {
        alertMessage.classList.remove('slide-in-active');
        alertMessage.classList.add('slide-out-active');
        setTimeout(() => {
            alertContainer.removeChild(alertMessage);
        }, 500);
    }, 3000); 
}


</script>  
</html>