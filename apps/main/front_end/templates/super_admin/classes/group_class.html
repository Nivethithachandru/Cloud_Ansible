<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="{{ url_for('static', path='/assets/') }}" 
  data-template="vertical-menu-template">
  <head>
    {% include 'header_file.html' %}

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>

        .alert-msg {
            background-color: #f44336; /* Red */
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            animation-duration: 0.6s;
            position: relative;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .slide-in {
            opacity: 0;
            transform: translateY(-20px);
        }

        .slide-in-active {
            opacity: 1;
            transform: translateY(0);
        }

        .slide-out {
            opacity: 1;
            transform: translateY(0);
        }

        .slide-out-active {
            opacity: 0;
            transform: translateY(-20px);
        }
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
            </style>
  </head>

  <body>

    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        {% include 'side_nav.html' %}
        <div class="layout-page">
          {% include 'header_nav.html' %}
          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
                <h4 class="py-3 breadcrumb-wrapper mb-4">
                    <span class="text-muted fw-light">   {{ session.role_name }} /</span> Group Class Assesments
                </h4>
                <div class="row mb-4">
                    
                    <div class="col-lg-6 col-md-8 col-sm-12">
                        <div class="card">
                          <h5 class="card-header">Group Class </h5>
                          <div class="card-body">
                            <form id="role_assessment_form">
                                <div id="loadingMessage" class="alert alert-info" style="display: none;"></div>
                                <div id="alertMessage" style="display: none;" class="mb-3 mt-3"></div>

                                <div class="mb-3">
                                    <label class="form-label" for="custom_class_id">Custom Class Name</label>
                                    <select class="form-control" id="custom_class_id" name="custom_class_id" required>
                                        <option value="" selected disabled>Select Custom Class</option>
                                        {% for class in custom_class %}
                                        <option value="{{ class.id }}">{{ class.custom_class }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="orginal_class_id" class="form-label select2-success">Map Weight Class</label>
                                    <select id="orginal_class_id" name="orginal_class_id[]" class="select2 form-select" multiple="multiple">
                                        <option value=""></option>
                                    </select>
                                </div>
                                

                                <div class="row">
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                </div>
                            </form>
                          </div>
                        </div>
                      </div>
                </div>
            </div>
            
            <!-- / Content -->

            

            <div class="content-backdrop fade"></div>
          </div>
        </div>
      </div>
      <div class="layout-overlay layout-menu-toggle"></div>

      <div class="drag-target"></div>
    </div>


    {% include 'script_file.html' %}
    
  </body>
 
  <script>
    $(document).ready(function () {
        $('#orginal_class_id').select2({
            placeholder: "Select Weight Class",  
            allowClear: true 
        });
    
        $("#custom_class_id").change(function(){
            var custom_id = $(this).val(); 
            console.log("Custom Class ID", custom_id);
    
            $.ajax({
                url: '/main/group_classes/fetch_ori_class/',
                type: 'POST',
                contentType: 'application/json',   
                data: JSON.stringify({ custom_id: custom_id }),  
                success: function(response){
                    var originalClasses = response.data;  
                    var checked_list_ids = response.already_exisit_list;
    
                    console.log("originalClasses", originalClasses);
                    console.log("checked_list_ids", checked_list_ids);
    
                    $("#orginal_class_id").empty(); 
                    $("#orginal_class_id").append(
                        $('<option></option>').attr("value", "ALL").text("Select All")
                    );
                    $.each(originalClasses, function(index, classData) {
                        var option = $('<option></option>')
                            .attr("value", classData.m_classes_id) 
                            .text(classData.m_classes_name); 
    
                        if (checked_list_ids.includes(classData.m_classes_id)) {
                            option.prop('selected', true); 
                        }
                        
                        $("#orginal_class_id").append(option);
                    });
    
                    $("#orginal_class_id").trigger('change'); 
                },
                error: function(xhr, status, error){
                    console.log("Error", error);  
                }
            });
        });
    });

    $('#orginal_class_id').on('select2:select', function (e) {
            var data = e.params.data;
            if (data.id === "ALL") {
                // Select all except "ALL"
                var allValues = [];
                $("#orginal_class_id option").each(function () {
                    if ($(this).val() !== "ALL") {
                        allValues.push($(this).val());
                    }
                });
                $('#orginal_class_id').val(allValues).trigger('change');
            }
        });

    
    
    $(document).ready(function () {
        $('#role_assessment_form').submit(function (e) {
            e.preventDefault();

            function showAlert(message, type = 'danger') {
                const alertMessageDiv = document.getElementById('alertMessage');
                alertMessageDiv.style.display = 'block';
                alertMessageDiv.innerText = message;
                alertMessageDiv.style.color = 'white';
                alertMessageDiv.style.backgroundColor = type === 'danger' ? 'red' : 'green';
                alertMessageDiv.style.padding = '10px';
                alertMessageDiv.style.borderRadius = '5px';
                setTimeout(function () {
                    alertMessageDiv.style.display = 'none';
                }, 5000);
            }

            function showLoading(message) {
                const loadingMessageDiv = document.getElementById('loadingMessage');
                loadingMessageDiv.style.display = 'block';
                loadingMessageDiv.innerText = message;
                loadingMessageDiv.style.color = 'white';
                loadingMessageDiv.style.backgroundColor = 'blue';
                loadingMessageDiv.style.padding = '10px';
                loadingMessageDiv.style.borderRadius = '5px';
            }

            function hideLoading() {
                const loadingMessageDiv = document.getElementById('loadingMessage');
                loadingMessageDiv.style.display = 'none';
            }

            let custom_class_id = $('#custom_class_id').val();
            let orginal_class_id = $('#orginal_class_id').val();

            showLoading("Submitting...");

            

            // -----------------------------------------------
            $.ajax({
                url: '/main/group_classes/add_update/',
                method: 'POST',
                contentType: "application/json",
                data: JSON.stringify({
                    custom_class_id: custom_class_id,
                    orginal_class_id: orginal_class_id
                }),
                success: function (response) {
                    //hideLoading();
                    //showAlert(`Custom Classes Mapped  successfully!`, 'success');
                    //console.log("Form Submitted Successfully:", response);
                    //$('#role_assessment_form')[0].reset();
                    //$('#orginal_class_id').val(null).trigger('change');  

                    hideLoading();

                    // Check backend message and show accordingly
                    if (response.message === "Mapping already exists for this custom class.") {
                        showAlert(response.message, 'info'); // info badge for existing mapping
                    } else {
                        showAlert(response.message || 'Custom Classes Mapped successfully!', 'success');
                    }

                    console.log("Form Submitted Successfully:", response);

                    // Reset form only if mapping was added/updated
                    if (response.message !== "Mapping already exists for this custom class.") {
                        $('#role_assessment_form')[0].reset();
                        $('#orginal_class_id').val(null).trigger('change');  
                    }

                },
                error: function (xhr) {
                    hideLoading();
                    let errorMessage = 'An unexpected error occurred. Please try again.';
                    if (xhr.status === 400) {
                        errorMessage = JSON.parse(xhr.responseText).detail;
                    }
                    showAlert("KIT IS OFFLINE", 'danger');
                }
            });
        });
    });


    function dbupdate() {
    fetch("/status_info", {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log("Fetched Data:", data);

        if (data.latest_status && data.latest_status.statuses && data.latest_status.statuses.mapping_status === true) {
            Toastify({
                text: data.latest_status.message || "Mapping Status is active!",
                duration: 6000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                stopOnFocus: true
            }).showToast();
        }
    })
    .catch(error => console.error("Error fetching status update:", error));
}

setInterval(dbupdate, 28000);
 
</script>
    
</html>
