<!DOCTYPE html>

<html lang="en"
 class="light-style layout-navbar-fixed layout-menu-fixed" 
 dir="ltr" data-theme="theme-default" data-assets-path="{{ url_for('static', path='/assets/') }}" data-template="vertical-menu-template">
  <head>
    {% include 'header_file.html' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
 
  </head>
  
  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->

        {% include 'side_nav.html' %}
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          {% include 'header_nav.html' %}

           

          <!-- / Navbar -->

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->

            <div class="container-xxl flex-grow-1 container-p-y">
              <h4 class="py-3 breadcrumb-wrapper mb-4">
                <span class="text-muted fw-light"> {{ session.role_name }} /</span> Custom Classes List
              </h4>

              <div class="" style="text-align: end;">
                <a class="btn btn-primary" href="{{ url_for('main.class_management') }}">
                    New Customs Class 
                </a>
              </div>

               

              <!-- Ajax Sourced Server-side -->
              <div class="card mt-5">
                <h5 class="card-header">Custom Classes List</h5>



                {% if session.role_id == 0 or page_permission %}

                <div class="card-datatable text-nowrap table-responsive">
                    <table class=" table table-bordered" id="roletable">
                        <thead>
                            <tr>
                                <th>S No.</th>
                                <th>Clases Name</th> 
                                <th>Model Group</th>                                                               
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                             
                        </tbody>
                    </table>
                </div>


                {% else %}
                
                
                        <div class=" h-100">
                            <div class="card-header">
                                <div class="alert alert-danger" role="alert">
                                    Access Denied: You do not have the necessary permissions to view this page.
                                </div>
                            </div>
                        </div>
                        
                {% endif %}




            </div>
              
       
              
            </div>
            
            </div>
          
            <div class="content-backdrop fade"></div>
          </div>
  
        </div>
 
      </div>
      <div class="layout-overlay layout-menu-toggle"></div>

      <div class="drag-target"></div>
    </div>

   {% include 'script_file.html' %}

  </body>
   
<script>

    const edit_permission = {{ 'true' if edit_permission else 'false' }};
    const delete_permission = {{ 'true' if delete_permission else 'false' }};
    
    console.log("Edit User permission:", edit_permission);
    console.log("Delete User permission:", delete_permission);




    $(document).ready(function() {
        $('#roletable').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "/main/classes/classeslist/",
                "dataSrc": "data"
            },
            "columns": [
                { "data": "serial_no" },
                { "data": "custom_class" },
                {
                    data: 'module_groups',
                    render: function(data) {
                        if (!data || data.length === 0) {
                            return `<span class="badge rounded-pill bg-label-info">Null</span>`;
                        }
                        const badges = data.map(item => {
                            return `<span class="badge rounded-pill bg-label-success">${item}</span>`;
                        });
                        return badges.join(' ');
                    }
                },
      
                {
                    "data": null,
                    "render": function(data, type, row) {
                        return `
                            <div class="dropdown">
                                <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item edit-class" href="javascript:void(0);" data-id="${row.id}">
                                        <i class="bx bx-edit-alt me-1"></i> Edit
                                    </a>
                                    <a class="dropdown-item delete-class" href="javascript:void(0);" data-id="${row.id}" data-class-name="${row.custom_class}">
                                        <i class="bx bx-trash me-1"></i> Delete
                                    </a>
                                    

                                </div>
                            </div>
                        `;
                    }
                }
            ]
        });
    
        // Handle Delete button click
        $('#roletable tbody').on('click', '.delete-class', function() {
    var classesId = $(this).data('id');       
    var classesName = $(this).data('class-name');   

    if (!delete_permission) {
        Swal.fire({
            title: 'Access Denied!',
            text: 'You do not have permission to delete Classes.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return; 
    }

    // Check LPU status before proceeding
    $.ajax({
        url: '/main/lpu/status_check',
        type: 'GET',
        success: function(response) {
            // If API returns success, allow deletion
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete the Custom Classes "${classesName}". This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/main/classes/delete/${classesId}`,   
                        method: 'DELETE',
                        success: function(response) {
                            Swal.fire('Deleted!', `The Classes "${classesName}" has been deleted.`, 'success');
                            $('#roletable').DataTable().ajax.reload();
                        },
                        error: function(xhr, status, error) {
                            Swal.fire('Error!', 'Failed to delete the Classes. Please try again.', 'error');
                        }
                    });
                }
            });
        },
        error: function(xhr) {
            if (xhr.status === 400) {
                Swal.fire({
                    title: 'KIT is Offline!',
                    text: 'Cannot delete classes while KIT is offline.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: 'An unexpected error occurred.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    });
});


        $('#roletable tbody').on('click', '.edit-class', function() {
    var classesId = $(this).data('id');  
    if (!edit_permission) {
        Swal.fire({
            title: 'Access Denied!',
            text: 'You do not have permission to edit Classes.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return; 
    }

    $.ajax({
        url: '/main/lpu/status_check',
        type: 'GET',
        success: function(response) {
        
            window.location.href = `/main/classes/edit/${classesId}`;
        },
        error: function(xhr) {
            if (xhr.status === 400) {
                Swal.fire({
                    title: 'KIT is Offline!',
                    text: 'Cannot edit classes while KIT is offline.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: 'An unexpected error occurred.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    });
});
    });
    


    
    
</script>
</html>