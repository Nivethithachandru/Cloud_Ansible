<!DOCTYPE html>

<html lang="en"
 class="light-style layout-navbar-fixed layout-menu-fixed" 
 dir="ltr" data-theme="theme-default" data-assets-path="{{ url_for('static', path='/assets/') }}" data-template="vertical-menu-template">
  <head>
    {% include 'header_file.html' %}
 
  </head>
  
  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->

        {% include 'side_nav.html' %}
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          {% include 'header_nav.html' %}

           

          <!-- / Navbar -->

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->

            <div class="container-xxl flex-grow-1 container-p-y">
              <h4 class="py-3 breadcrumb-wrapper mb-4">
                <span class="text-muted fw-light"> {{ session.role_name }} /</span> Roles List
              </h4>

              

              <!-- Ajax Sourced Server-side -->
              <div class="card mt-5">
                <h5 class="card-header">Roles List</h5>













                {% if session.role_id == 0 or page_permission%}

                <div class="card-datatable text-nowrap table-responsive">
                    <table class=" table table-bordered" id="roletable">
                        <thead>
                            <tr>
                                <th>Role ID.</th>
                                <th>Role Name</th>
                                <th>Role Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                             
                        </tbody>
                    </table>
                </div>


                {% else %}
 
                <div class=" h-100">
                    <div class="card-header">
                        <div class="alert alert-danger" role="alert">
                            Access Denied: You do not have the necessary permissions to view this page.
                        </div>
                    </div>
                </div>
                    
                         
                        
                {% endif %}






                









            </div>
              <!--/ Ajax Sourced Server-side -->

              
       
              
            </div>
            
            </div>
          
            <div class="content-backdrop fade"></div>
          </div>
  
        </div>
 
      </div>
      <div class="layout-overlay layout-menu-toggle"></div>

      <div class="drag-target"></div>
    </div>

   {% include 'script_file.html' %}

  </body>
   
<script>
    const role_id ={{ role_id }}
    const edit_permission = {{ 'true' if edit_permission else 'false' }};
    const delete_permission = {{ 'true' if delete_permission else 'false' }};
    
    console.log("Role ID", role_id);
    console.log("Edit User permission:", edit_permission);
    console.log("Delete User permission:", delete_permission);

    $(document).ready(function() {
        function createDropdown(row) {
            let dropdownHtml = `
                <div class="dropdown">
                     <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bx bx-dots-vertical-rounded"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item edit-role" href="javascript:void(0);" data-id="${row.id}">
                            <i class="bx bx-edit-alt me-1"></i> Edit
                        </a>
                        <a class="dropdown-item delete-role" href="javascript:void(0);" data-id="${row.id}" data-role-name="${row.role_name}">
                            <i class="bx bx-trash me-1"></i> Delete
                        </a>
                        <a class="dropdown-item permission-role" href="javascript:void(0);" data-id="${row.id}" data-role-name="${row.role_name}">
                            <i class="fa fa-shield me-1" style=" color:green"></i> Permission
                        </a> `;
                        if (role_id === 0) {
                            if (row.is_blocked) {
                                dropdownHtml += `
                                    <a class="dropdown-item unblock-role" href="javascript:void(0);" data-id="${row.id}" data-role-name="${row.role_name}">
                                        <i class="bx bx-check me-1"></i> Unblock
                                    </a>`;
                            } else {
                                dropdownHtml += `
                                    <a class="dropdown-item block-role" href="javascript:void(0);" data-id="${row.id}" data-role-name="${row.role_name}">
                                        <i class="bx bx-block me-1"></i> Block
                                    </a>`;
                            }
                        }        
                        dropdownHtml += `
                                </div>
                            </div>
                        `;        
                        return dropdownHtml; 
        }

        $('#roletable').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "/main/roles/rolelist/",
                "dataSrc": function(json) {
                    if (role_id === 0) {
                        return json.data;
                    } else {
                        return json.data.filter(function(role) {
                            return role.id !== role_id && role.id !== 5;
                        });
                    }
                }
            },
            "columns": [
                { "data": "id" },
                { "data": "role_name" },
                { "data": "role_bio" },
                {
                    "data": null,                    
                    "render": function(data, type, row) {
                        return createDropdown(row); 
                    }
                }
            ]
        });
    
        $('#roletable tbody').on('click', '.delete-role', function() {
            var roleId = $(this).data('id');       
            var roleName = $(this).data('role-name');   
            if (!delete_permission) {
                Swal.fire({
                    title: 'Access Denied!',
                    text: 'You do not have permission to delete users.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return; 
            }
            
            // Show SweetAlert confirmation dialog
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete the role "${roleName}". This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Perform delete request if confirmed
                    $.ajax({
                        url: `/main/roles/delete/${roleId}`,  // API endpoint for deletion
                        method: 'DELETE',
                        success: function(response) {
                            // Show success message with role name
                            Swal.fire('Deleted!', `The role "${roleName}" has been deleted.`, 'success');
    
                            // Reload the DataTable to reflect the deletion
                            $('#roletable').DataTable().ajax.reload();
                        },
                        error: function(xhr, status, error) {
                            // Handle errors (optional)
                            Swal.fire('Error!', 'Failed to delete the role. Please try again.', 'error');
                        }
                    });
                }
            });
        });


        $('#roletable tbody').on('click', '.edit-role', function() {
            var roleId = $(this).data('id');  
            if (!edit_permission) {
                Swal.fire({
                    title: 'Access Denied!',
                    text: 'You do not have permission to edit role.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return; 
            }

            window.location.href = `/main/roles/edit/${roleId}`;
        });
        const permitted_list_role_ids = {{ permitted_list_role_ids | tojson }};

        $('#roletable tbody').on('click', '.permission-role', function() {
            var roleId = $(this).data('id');  
            console.log("Get Row id",roleId)
            console.log("Current role id",role_id)
            console.log("Permission grannted role id",permitted_list_role_ids)
                
            if (role_id == 0 || role_id == 5){                                
                if (permitted_list_role_ids.includes(role_id)){       
                    window.location.href = `/main/roles/permission/${roleId}`;
                    return;
                }else{
                    Swal.fire({
                        title: 'Access Denied!',
                        text: 'You do not have permission to set role.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            }
             
            if (permitted_list_role_ids.includes(role_id)){                
                if (roleId !== role_id){
                    window.location.href = `/main/roles/permission/${roleId}`;
                    return;
                }else{
                    Swal.fire({
                        title: 'Access Denied!',
                        text: 'You do not have permission to set role.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
                

            }else{
                Swal.fire({
                    title: 'Access Denied!',
                    text: 'You do not have permission to set role.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
            

        });


        // Block the role
        // Handle Block button click
        $('#roletable tbody').on('click', '.block-role', function() {
            var roleId = $(this).data('id');   
            var roleName = $(this).data('role-name');   

            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to block the role "${roleName}". This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, block it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/main/roles/block/${roleId}`,  
                        method: 'POST', 
                        success: function(response) {
                            Swal.fire('Blocked!', `The role "${roleName}" has been blocked.`, 'success');
                            $('#roletable').DataTable().ajax.reload();
                        },
                        error: function(xhr, status, error) {
                            Swal.fire('Error!', 'Failed to block the role. Please try again.', 'error');
                        }
                    });
                }
            });
        });
        $('#roletable tbody').on('click', '.unblock-role', function() {
            var roleId = $(this).data('id');   
            var roleName = $(this).data('role-name');   
        
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to unblock the role "${roleName}". This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, unblock it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: `/main/roles/unblock/${roleId}`,  
                        method: 'POST', 
                        success: function(response) {
                            Swal.fire('Unblocked!', `The role "${roleName}" has been unblocked.`, 'success');
                            $('#roletable').DataTable().ajax.reload();
                        },
                        error: function(xhr, status, error) {
                            Swal.fire('Error!', 'Failed to unblock the role. Please try again.', 'error');
                        }
                    });
                }
            });
        });
        // Block the role
    });
    
</script>
</html>